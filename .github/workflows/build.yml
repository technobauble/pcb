name: Build and Test

on:
  push:
    branches: [ master, "claude/**" ]
  pull_request:
    branches: [ master ]

jobs:
  build-linux:
    name: Linux Build (${{ matrix.config.name }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        config:
          - name: "GTK GUI"
            configure_flags: "--with-gui=gtk --disable-doc --disable-dbus --disable-update-desktop-database"

          - name: "GTK + OpenGL"
            configure_flags: "--with-gui=gtk --enable-gl --disable-doc --disable-dbus --disable-update-desktop-database"

          - name: "Batch (Headless)"
            configure_flags: "--with-gui=batch --disable-doc --disable-dbus --disable-update-desktop-database"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for version detection

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          libtool \
          flex \
          bison \
          m4 \
          gawk \
          pkg-config \
          libglib2.0-dev \
          libgtk2.0-dev \
          libgtkglext1-dev \
          libgd-dev \
          libdbus-1-dev \
          gerbv \
          ghostscript \
          imagemagick \
          wish \
          tcl

    - name: Cache autotools
      uses: actions/cache@v4
      with:
        path: |
          autom4te.cache
          aclocal.m4
        key: ${{ runner.os }}-autotools-${{ hashFiles('configure.ac', 'acinclude.m4') }}

    - name: Run autogen.sh
      run: |
        ./autogen.sh
        echo "âœ… autogen.sh completed successfully" >> $GITHUB_STEP_SUMMARY

    - name: Configure
      run: |
        ./configure ${{ matrix.config.configure_flags }} 2>&1 | tee configure.log
        echo "âœ… Configure completed for: ${{ matrix.config.name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Configure flags:** \`${{ matrix.config.configure_flags }}\`" >> $GITHUB_STEP_SUMMARY

    - name: Build
      run: |
        make -j$(nproc) 2>&1 | tee build.log
        echo "âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY

    - name: Run tests
      run: |
        make check 2>&1 | tee test.log
        test_exit_code=${PIPESTATUS[0]}

        # Check for actual test failures
        if [ $test_exit_code -ne 0 ] || grep -q "^FAIL:" test.log; then
          echo "## âŒ Tests Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show the test summary with failed test list
          if grep -q "FAILED TESTS:" test.log; then
            echo "### Failed Tests:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            sed -n '/FAILED TESTS:/,/^------/p' test.log | head -50 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Show stderr from failed tests
          echo "### Test Error Output (stderr):" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          for errlog in tests/outputs/*/run_tests.err.log; do
            if [ -f "$errlog" ] && [ -s "$errlog" ]; then
              testname=$(basename $(dirname "$errlog"))
              echo "=== $testname ===" >> $GITHUB_STEP_SUMMARY
              cat "$errlog" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show brief failure details from test-suite.log if it exists
          if [ -f tests/test-suite.log ]; then
            echo "### Test Suite Log:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            # Show failures and errors from test-suite.log
            grep -A 20 "FAIL:" tests/test-suite.log | head -100 >> $GITHUB_STEP_SUMMARY || \
            tail -100 tests/test-suite.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Full logs available in build artifacts**" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        echo "âœ… Tests passed" >> $GITHUB_STEP_SUMMARY
      continue-on-error: false

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ matrix.config.name }}
        path: |
          configure.log
          build.log
          test.log
          src/unittest.log
          tests/test-suite.log
          tests/*.log
          tests/outputs/*/run_tests.err.log
        retention-days: 7
        if-no-files-found: ignore

    - name: Report test failures
      if: failure()
      run: |
        echo "## âŒ Build Failed: ${{ matrix.config.name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f src/unittest.log ]; then
          echo "### Unit Test Log" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 src/unittest.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        if [ -f tests/test-suite.log ]; then
          echo "### Test Suite Log" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 tests/test-suite.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

    # Distcheck disabled: requires doc build infrastructure (ghostscript/texinfo)
    # that we're not setting up yet. Distcheck verifies tarball creation/testing,
    # which is primarily needed for releases. Regular build+test is sufficient for CI.
    #
    # - name: Run distcheck
    #   if: matrix.config.name == 'Batch (Headless)'
    #   run: |
    #     echo "DISTCHECK_CONFIGURE_FLAGS from Makefile:"
    #     grep "^DISTCHECK_CONFIGURE_FLAGS" Makefile || echo "Not found in Makefile"
    #     make distcheck V=1

    - name: Upload build artifacts
      if: matrix.config.name == 'GTK GUI'
      uses: actions/upload-artifact@v4
      with:
        name: pcb-linux-gtk
        path: |
          src/pcb
        retention-days: 7

  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          libtool \
          flex \
          bison \
          m4 \
          gawk \
          pkg-config \
          libglib2.0-dev \
          libgtk2.0-dev \
          libgtkglext1-dev \
          libgd-dev \
          libdbus-1-dev \
          gerbv \
          ghostscript \
          imagemagick \
          wish \
          tcl \
          lcov

    - name: Run autogen.sh
      run: ./autogen.sh

    - name: Configure with coverage enabled
      run: |
        ./configure --enable-coverage --disable-doc --disable-dbus --disable-update-desktop-database --with-gui=batch
        echo "âœ… Configured with coverage enabled" >> $GITHUB_STEP_SUMMARY

    - name: Build
      run: |
        make -j$(nproc)
        echo "âœ… Build completed" >> $GITHUB_STEP_SUMMARY

    - name: Run tests
      run: |
        make check
        echo "âœ… Tests completed" >> $GITHUB_STEP_SUMMARY

    - name: Generate coverage report
      run: |
        echo "## ðŸ“Š Code Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Capture coverage data
        lcov --capture --directory . --output-file coverage.info

        # Remove external/generated code from coverage
        lcov --remove coverage.info \
          '/usr/*' \
          '*/gts/*' \
          '*/parse_y.c' \
          '*/parse_l.c' \
          '*/edif.c' \
          '*/tests/*' \
          --output-file coverage_filtered.info

        # Generate summary
        lcov --list coverage_filtered.info > coverage_summary.txt

        # Extract key metrics
        TOTAL_LINES=$(grep -oP 'lines\.*: \K[0-9.]+(?=%)' coverage_summary.txt | tail -1)
        echo "- **Total Coverage:** ${TOTAL_LINES}%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Show top 10 files by coverage
        echo "### Top Files by Coverage" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        head -20 coverage_summary.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage_filtered.info
        fail_ci_if_error: false
        verbose: true

    - name: Upload coverage artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          coverage_filtered.info
          coverage_summary.txt
        retention-days: 30

  memory-safety:
    name: Memory Safety (AddressSanitizer)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          libtool \
          flex \
          bison \
          m4 \
          gawk \
          pkg-config \
          libglib2.0-dev \
          libgtk2.0-dev \
          libgtkglext1-dev \
          libgd-dev \
          libdbus-1-dev \
          gerbv \
          ghostscript \
          imagemagick \
          wish \
          tcl

    - name: Run autogen.sh
      run: ./autogen.sh

    - name: Configure with AddressSanitizer
      run: |
        ./configure \
          CFLAGS="-fsanitize=address -g -O1 -fno-omit-frame-pointer" \
          LDFLAGS="-fsanitize=address" \
          --disable-doc \
          --disable-dbus \
          --disable-update-desktop-database \
          --with-gui=batch
        echo "âœ… Configured with AddressSanitizer" >> $GITHUB_STEP_SUMMARY

    - name: Build
      run: |
        make -j$(nproc)
        echo "âœ… Build completed" >> $GITHUB_STEP_SUMMARY

    - name: Run unit tests with ASan
      run: |
        echo "## ðŸ›¡ï¸ Memory Safety Testing" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        cd src
        if [ -f ./unittest ]; then
          ./unittest 2>&1 | tee ../asan-unittest.log || true
          if grep -q "ERROR: AddressSanitizer" ../asan-unittest.log; then
            echo "- âŒ Memory errors detected in unit tests" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… Unit tests passed (no memory errors)" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- âš ï¸ Unit tests not built" >> $GITHUB_STEP_SUMMARY
        fi
        cd ..
      continue-on-error: true

    - name: Run integration tests with ASan
      run: |
        cd tests
        # Run a subset of fast tests to avoid timeout
        ./run_tests.sh hid_bom1 hid_png1 2>&1 | tee ../asan-tests.log || true

        if grep -q "ERROR: AddressSanitizer" ../asan-tests.log; then
          echo "- âŒ Memory errors detected in integration tests" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âœ… Integration tests passed (no memory errors)" >> $GITHUB_STEP_SUMMARY
        fi
        cd ..
      continue-on-error: true

    - name: Upload ASan logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: asan-logs
        path: |
          asan-unittest.log
          asan-tests.log
        retention-days: 30

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cppcheck \
          clang-tidy \
          build-essential \
          autoconf \
          automake \
          libtool \
          flex \
          bison \
          m4 \
          gawk \
          pkg-config \
          libglib2.0-dev \
          libgtk2.0-dev \
          libgd-dev

    - name: Run cppcheck
      run: |
        echo "## ðŸ” Code Quality Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        cppcheck --enable=warning,style,performance,portability \
          --error-exitcode=0 \
          --inline-suppr \
          --suppress=missingIncludeSystem \
          --quiet \
          src/ 2>&1 | tee cppcheck-report.txt
        ISSUE_COUNT=$(wc -l < cppcheck-report.txt)
        echo "### cppcheck Results" >> $GITHUB_STEP_SUMMARY
        echo "Found $ISSUE_COUNT potential issues" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
      continue-on-error: true

    - name: Upload cppcheck report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cppcheck-report
        path: cppcheck-report.txt
        retention-days: 30

    - name: Run autogen for clang-tidy
      run: ./autogen.sh
      continue-on-error: true

    - name: Configure for clang-tidy
      run: |
        ./configure --disable-doc --disable-dbus --disable-update-desktop-database --with-gui=batch
      continue-on-error: true

    - name: Run clang-tidy
      run: |
        echo "### clang-tidy Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Run clang-tidy on a subset of files (to avoid timeout)
        clang-tidy src/*.c \
          -p=. \
          -- -I. -Isrc $(pkg-config --cflags glib-2.0 2>/dev/null || echo "") \
          2>&1 | tee clang-tidy-report.txt || true

        ISSUE_COUNT=$(grep -c "warning:" clang-tidy-report.txt || echo "0")
        ERROR_COUNT=$(grep -c "error:" clang-tidy-report.txt || echo "0")

        echo "- Warnings: $ISSUE_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "- Errors: $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
      continue-on-error: true

    - name: Upload clang-tidy report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: clang-tidy-report
        path: clang-tidy-report.txt
        retention-days: 30

    - name: Check for obsolete C keywords
      run: |
        echo "### Legacy Code Patterns" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Checking for obsolete 'register' keyword..."
        REGISTER_COUNT=$(grep -r "register " src/ --include="*.c" --include="*.h" | wc -l || echo "0")
        if [ "$REGISTER_COUNT" -gt 0 ]; then
          echo "- âš ï¸ Found $REGISTER_COUNT uses of obsolete \`register\` keyword" >> $GITHUB_STEP_SUMMARY
          echo "::warning::Found $REGISTER_COUNT uses of obsolete 'register' keyword"
        else
          echo "- âœ… No obsolete \`register\` keywords found" >> $GITHUB_STEP_SUMMARY
        fi
      continue-on-error: true

    - name: Check for CVS artifacts
      run: |
        echo "Checking for CVS artifacts..."
        CVS_COUNT=$(find . -name ".cvsignore" | wc -l)
        if [ "$CVS_COUNT" -gt 0 ]; then
          echo "- âš ï¸ Found $CVS_COUNT CVS .cvsignore files that should be removed" >> $GITHUB_STEP_SUMMARY
          echo "::warning::Found $CVS_COUNT CVS .cvsignore files"
        else
          echo "- âœ… No CVS artifacts found" >> $GITHUB_STEP_SUMMARY
        fi
      continue-on-error: true

  build-summary:
    name: Build Summary
    needs: [build-linux, code-coverage, memory-safety, code-quality]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Generate build report
      run: |
        echo "# ðŸ”¨ PCB Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.build-linux.result }}" == "success" ]; then
          echo "| Linux Builds (3 configs) | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Linux Builds (3 configs) | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.code-coverage.result }}" == "success" ]; then
          echo "| Code Coverage | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Code Coverage | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.memory-safety.result }}" == "success" ]; then
          echo "| Memory Safety (ASan) | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Memory Safety (ASan) | âš ï¸ Warnings |" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.code-quality.result }}" == "success" ]; then
          echo "| Code Quality Checks | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Code Quality Checks | âš ï¸ Warnings |" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Build logs and artifacts are available for download in the workflow artifacts." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Build logs for each configuration" >> $GITHUB_STEP_SUMMARY
        echo "- Code coverage report (lcov)" >> $GITHUB_STEP_SUMMARY
        echo "- Code quality reports (cppcheck)" >> $GITHUB_STEP_SUMMARY
        echo "- Built PCB binary (GTK GUI)" >> $GITHUB_STEP_SUMMARY

    - name: Check build status
      run: |
        if [ "${{ needs.build-linux.result }}" != "success" ]; then
          echo "::error::Linux builds failed"
          exit 1
        fi
        echo "All builds completed successfully!"
