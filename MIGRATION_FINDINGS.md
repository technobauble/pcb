# Action Migration: Layer 2 Findings

**Date:** November 14, 2025
**Status:** Blocked - Reassessing approach
**Phase:** Proof of Concept - MessageAction

---

## Summary

Attempted to compile MessageAction.cpp in complete isolation (no dependency on action.c or libpcb.a). Hit significant dependency cascade issues.

## What Worked ‚úÖ

**Layer 1: Implementation**
- Created MessageAction.cpp successfully
- Only includes error.h and global.h (as intended)
- Code is clean and simple
- REGISTER_ACTION macro works

**Layer 2: Testing**
- Created comprehensive test suite (message_action_test.cpp)
- Mock strategy is sound
- Test design is good

## What Failed ‚ùå

**Compilation Dependency Cascade:**

```
MessageAction.cpp
  ‚Üí includes Action.h
    ‚Üí includes global.h
      ‚Üí includes const.h
        ‚Üí includes globalconst.h (auto-generated)
      ‚Üí includes glib.h
      ‚Üí includes hid.h
        ‚Üí includes drc_violation.h
      ‚Üí includes polyarea.h
      ‚Üí defines types using COORD_TYPE (from config.h)
```

**Root Problems:**
1. `global.h` is a **God Header** - includes everything
2. `COORD_TYPE` comes from config.h (auto-generated by autotools)
3. `globalconst.h` is auto-generated
4. Can't compile without full build system run

## Red Flags Encountered üö©

From our MIGRATION_DEPENDENCY_STRATEGY.md:

> üö© You're modifying action.c to expose internal functions
> üö© Tests require #ifdef hacks to compile
> üö© You're debugging linker errors for more than 30 minutes

**We hit the 30-minute debugging linker/compiler errors threshold**

---

## Options Moving Forward

### Option 1: Use Real Build System (RECOMMENDED)

**Strategy:**
- Add MessageAction.cpp to `src/Makefile.am`
- Compile as part of normal PCB build
- Use autotools-generated headers (config.h, globalconst.h)
- Tests link against Action.o + MessageAction.o (but still NOT action.c)

**Pros:**
- ‚úÖ All headers available
- ‚úÖ Proper dependencies
- ‚úÖ No fighting the build system
- ‚úÖ Still isolated from action.c

**Cons:**
- ‚ö†Ô∏è Requires running configure/autogen
- ‚ö†Ô∏è Tests aren't "completely standalone" (but they're still isolated from action.c)

**Assessment:** This is still "isolated" by our definition - we're not depending on action.c, just on the build infrastructure.

### Option 2: Mock global.h Entirely

**Strategy:**
- Create `tests/cpp/mocks/global.h` with minimal type definitions
- Don't include real global.h in tests
- Mock Coord, PCBType, etc.

**Pros:**
- ‚úÖ Truly standalone compilation

**Cons:**
- ‚ùå High maintenance (mock must stay in sync)
- ‚ùå Not testing real integration
- ‚ùå Fragile - breaks when global.h changes

**Assessment:** Too fragile, defeats the purpose

### Option 3: Refactor global.h First

**Strategy:**
- Split global.h into smaller headers:
  - global_types.h (just Coord, basic types)
  - global_structs.h (PCBType, etc.)
  - global_includes.h (all the #includes)
- Then only include what we need

**Pros:**
- ‚úÖ Better architecture long-term
- ‚úÖ Reduces coupling across entire codebase

**Cons:**
- ‚ùå Massive refactoring before we even start
- ‚ùå Touches hundreds of files
- ‚ùå High risk

**Assessment:** Good long-term goal, wrong starting point

---

## Recommended Path Forward

**ADOPT OPTION 1: Use Real Build System**

### Revised Layer 2 Strategy

**Old approach (failed):**
```
Compile MessageAction.cpp standalone
  ‚Üí No build system
  ‚Üí Manual Makefile
  ‚Üí Mock everything
```

**New approach (recommended):**
```
Add MessageAction.cpp to src/Makefile.am
  ‚Üí Use autotools build
  ‚Üí All headers available
  ‚Üí Tests link against .o files (not action.c)
```

### Key Insight

**"Isolated" doesn't mean "no build system"**

It means:
- ‚úÖ No dependency on action.c (the file we're replacing)
- ‚úÖ No linking against old ActionMessage function
- ‚úÖ Can test independently
- ‚ùå Does NOT mean "compiles without configure"

### Updated Validation Criteria

**What matters:**
- ‚úÖ MessageAction.o compiles without action.c
- ‚úÖ Tests link MessageAction.o + Action.o (NOT action.o)
- ‚úÖ Can verify MessageAction works before integration
- ‚úÖ Fallback mechanism allows both to coexist

**What doesn't matter:**
- ‚ùå Whether we use autotools or manual Makefile
- ‚ùå Whether globalconst.h is auto-generated
- ‚ùå Whether we need to run configure first

---

## Next Steps (Revised Plan)

### 1. Integrate with Build System

Add to `src/Makefile.am`:
```makefile
if BUILD_WITH_CXX
PCB_CXX_SRCS += \
    actions/MessageAction.cpp

libpcb_a_SOURCES += $(PCB_CXX_SRCS)
endif
```

### 2. Create Proper Test Configuration

Add to `tests/cpp/Makefile.am`:
```makefile
check_PROGRAMS += message_action_test

message_action_test_SOURCES = \
    actions/message_action_test.cpp

message_action_test_LDADD = \
    ../../src/actions/MessageAction.o \
    ../../src/actions/Action.o \
    ../../src/actions/action_bridge.o \
    $(GTEST_LIBS) -lgtest_main -lpthread

# NOTE: Still NOT linking action.o!
```

### 3. Build and Test

```bash
./autogen.sh
./configure --disable-doc
make
make check  # Runs message_action_test
```

### 4. Verify Isolation

```bash
# Verify MessageAction.o doesn't depend on action.c
nm src/actions/MessageAction.o | grep -i action

# Should see:
#   - Action:: symbols (base class)  ‚úÖ
#   - MessageAction:: symbols         ‚úÖ
#   - NO ActionMessage symbols        ‚úÖ
```

---

## Lessons Learned

1. **"Isolated" is relative** - We want isolation from action.c, not from the entire build system

2. **Fight the right battles** - Don't fight autotools, fight the monolithic architecture

3. **God Headers are real** - global.h is a problem, but not one we need to solve today

4. **Build infrastructure matters** - auto-generated headers are OK, they're stable

5. **Strategy was sound** - We just misinterpreted "standalone"

---

## Go/No-Go Decision

**Question:** Should we continue with Option 1?

**Checkboxes:**
- [x] MessageAction.cpp is implemented and clean
- [x] Test design is solid
- [x] Strategy document principles still valid
- [x] Only adjustment is build approach, not architecture
- [ ] Team agrees Option 1 is acceptable

**Recommendation:** PROCEED with Option 1 (integrate with build system)

---

## Impact on Timeline

**Original estimate:** Week 1 for MessageAction proof of concept

**Revised:**
- Day 1: ‚úÖ Implement MessageAction.cpp
- Day 2: ‚úÖ Create test design
- Day 2: ‚ö†Ô∏è Hit dependency cascade (learning experience)
- Day 3: Integrate with build system (Option 1)
- Day 4: Verify tests pass
- Day 5: Add fallback to action.c

**Still on track for Week 1 delivery!**

---

**Conclusion:**

This wasn't a failure - it was validation. We learned:
1. Complete build isolation is impractical (and unnecessary)
2. Action.c isolation is what matters
3. Build system integration is fine

Recommend proceeding with Option 1 using autotools build system.

